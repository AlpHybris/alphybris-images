#!/bin/bash

while [ "$1" != "" ]; do
    case $1 in
    -n | --image-name)
          shift
          IMAGE_NAME=$1
          ;;
     # Add more options as required
    *)
          exit 1
          ;;
    esac
    shift
done

[ "$IMAGE_NAME" == "" ] && IMAGE_NAME=rootfs.img || true

umount -l alpine-chroot/sys
umount -l alpine-chroot/dev
umount -l alpine-chroot/proc

SIZE=$(du -s --block-size=GB alpine-chroot/ | awk '{print $1}' | sed -e 's/GB//g')
REAL_SIZE=$(awk -v size="$SIZE" 'BEGIN { printf "%.1f", size + 0.5 }')

fallocate -l "$REAL_SIZE"G $IMAGE_NAME
mkfs.ext4 -F $IMAGE_NAME
modprobe loop

mkdir mountpoint/
mount $IMAGE_NAME mountpoint/
rsync -aHAX --delete --numeric-ids --progress alpine-chroot/ mountpoint/
touch mountpoint/.writable_image

umount mountpoint/
